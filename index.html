<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Der letzte Weihnachtszauber ‚Äì Hapimag Saalbach</title>

<style>
:root{
  --rot: #b01823;
  --rot-hell: #e03a45;
  --gruen: #0d4b32;
  --gruen-hell: #1f6f49;
  --karte: rgba(255,255,255,0.97);
  --radius: 22px;
  --shadow: 0 10px 40px rgba(0,0,0,0.22);
  --text: #222;
}

/* --- GLOBAL --- */
body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
  color:var(--text);
  min-height:100vh;

  background-image:url("Winterlandschaft.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}

.wrap{
  width:min(980px,100%);
  margin:auto;
  padding:18px;
}

.card{
  background:var(--karte);
  padding:24px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* --- HEAD --- */
.head{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px;
  align-items:center;
}

.logo-mini{
  width:70px;
}

.title{
  margin:0;
  color:var(--rot);
  font-size:clamp(1.6rem,2vw,2rem);
}

.badge{
  display:inline-block;
  margin-top:4px;
  padding:4px 10px;
  background:#fff0f0;
  color:var(--rot);
  border-radius:14px;
  font-size:.85rem;
  border:1px solid #ffd0d0;
}

/* --- BUTTONS --- */
button{
  cursor:pointer;
  padding:.9rem 1.4rem;
  border-radius:14px;
  border:2px solid var(--rot);
  background:var(--rot);
  color:white;
  font-weight:700;
  font-size:1rem;
  transition:0.2s;
}

button.secondary{
  background:white;
  color:var(--rot);
}

button:hover{
  filter:brightness(1.12);
}

button:disabled{
  opacity:0.4;
  cursor:not-allowed;
}

/* --- INPUT --- */
label{
  font-weight:600;
  margin-top:1rem;
  display:block;
}

input{
  width:100%;
  padding:1rem;
  margin-top:.3rem;
  border:2px solid #ffdbde;
  border-radius:14px;
  font-size:1rem;
}

/* --- FEEDBACK --- */
.err{
  display:none;
  color:#c62828;
  font-weight:700;
  margin-top:.7rem;
}

.ok{
  display:none;
  background:#e8ffe8;
  border:2px solid #62c06c;
  padding:.9rem 1rem;
  margin-top:.9rem;
  border-radius:14px;
  color:#115b17;
  font-weight:700;
}

/* --- ORT BOX --- */
.loc{
  display:none;
  margin-top:1rem;
  padding:1rem;
  background:#fff7f7;
  border:2px solid #ffd1d1;
  border-radius:14px;
  font-weight:700;
}

/* --- OVERLAY --- */
.fullOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
}

.introBox,
.popupBox,
.levelBox,
.puzzleBox{
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  width:min(900px,92%);
  max-height:92vh;
  display:flex;
  flex-direction:column;
}

.introInner,
.popupInner{
  padding:24px;
  text-align:center;
}

.intro-santa{
  width:220px;
  display:block;
  margin:auto;
  margin-bottom:14px;
}

.hapimag-logo{
  width:120px;
  display:block;
  margin:auto;
  margin-top:5px;
}

.popupFooter{
  padding:14px;
  background:#fff5f5;
  border-top:1px solid #ffd5d5;
  text-align:center;
}

/* --- PUZZLE --- */
.puzzleSlots,
.puzzleLetters{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
  margin-top:20px;
}

.slot{
  width:60px;
  height:60px;
  border:2px dashed var(--rot);
  border-radius:14px;
  font-size:1.7rem;
  font-weight:700;
  color:var(--rot);
  background:#fffafa;
  display:flex;
  align-items:center;
  justify-content:center;
}

.letterTile{
  width:60px;
  height:60px;
  background:var(--rot);
  border-radius:14px;
  color:white;
  font-size:1.7rem;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
}

.letterTile:active{
  transform:scale(1.08);
}

/* MOBILE */
@media(max-width:600px){
  .slot, .letterTile{
    width:70px;
    height:70px;
    font-size:1.9rem;
  }
  .intro-santa{width:160px;}
}

</style>
</head>

<body>

<!-- INTRO -->
<div id="introOverlay" class="fullOverlay">
  <div class="introBox">
    <div class="introInner">

      <h2 class="introTitle">Der letzte Weihnachtszauber</h2>
      <img src="Weihnachtsmann.jpg" class="intro-santa">
      <img src="Hapimag Logo.png" class="hapimag-logo">

      <p class="introText">
        In der l√§ngsten Nacht des Winters liegt das alte Haus still im Schnee ‚Äì und doch scheint es zu atmen.
        Drinnen flackert ein schwaches Licht, als w√ºrde jemand warten. Vor langer Zeit verga√ü das Christkind hier ein letztes Geschenk.
        Eine Truhe, versiegelt mit einem Zahlencode, den selbst der Himmel nicht mehr kennt. Seit jener Nacht ruht der Weihnachtszauber in ihr ‚Äì unerweckt, unerl√∂st.
        <br><br>
        Doch das Haus ist nicht stumm. Es fl√ºstert R√§tsel durch seine Flure, l√§sst Schatten tanzen und Kerzen flackern, als wollten sie f√ºhren.
        Wer genau hinh√∂rt, sp√ºrt, dass die Antworten verborgen sind ‚Äì im Knirschen des Schnees, im Wispern des Windes, in Zeichen, die nur im richtigen Moment sichtbar werden.
        <br><br>
        Zw√∂lf R√§tsel f√ºhren zur L√∂sung. Folge dem Ruf der Nacht ‚Äì vielleicht findest du das Geschenk, das das Christkind selbst vergessen hat.
      </p>

      <button id="readIntro" class="secondary">‚ñ∂Ô∏è Vorlesen</button>
      <audio id="introAudio" preload="auto" src="ElevenLabs_Text_to_Speech_audio.mp3"></audio>

    </div>

    <div class="popupFooter">
      <button id="startBtn" disabled style="display:none;">Weiter zur R√§tseltour ‚ú®</button>
    </div>
  </div>
</div>
<!-- POPUP nach richtigem Buchstaben -->
<div id="letterPopup" class="fullOverlay" style="display:none;">
  <div class="popupBox">
    <div class="popupInner">
      <h2>Gut gemacht! üéÑ‚ú®</h2>
      <p id="popupText">Du hast eine geheimnisvolle Spur gefunden!</p>
    </div>
    <div class="popupFooter">
      <button id="popupNextBtn">Weiter ‚ûú</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<main class="wrap">
  <section class="card" id="mainCard" style="display:none;">

    <header class="head">
      <img src="Hapimag Logo.png" class="logo-mini">

      <div>
        <h1 class="title">Der letzte Weihnachtszauber</h1>
        <p class="sub">Finde alle 12 Buchstaben ‚Äì dann entsteht das L√∂sungswort</p>
        <span class="badge" id="badge"></span>
      </div>

      <img src="Weihnachtsmann.jpg" class="logo-mini">
    </header>

    <h2 id="riddleTitle">R√§tsel</h2>
    <p id="riddleText"></p>

    <label>Deine Antwort</label>
    <input id="answerInput" autocomplete="off" placeholder="Antwort eingeben‚Ä¶">

    <button id="checkAnswerBtn" style="margin-top:1rem;">Antwort pr√ºfen</button>

    <div class="err" id="errBox">Leider falsch ‚Äì versuch‚Äôs nochmal!</div>
    <div class="ok" id="okBox">Richtig!</div>

    <div id="locBox" class="loc"></div>

    <div id="letterStep" style="display:none;">
      <label>Buchstabe am Ort</label>
      <input id="letterInput" maxlength="1" placeholder="Buchstabe eingeben‚Ä¶">
    </div>

  </section>
</main>

<!-- PUZZLE OVERLAY -->
<div id="puzzleOverlay" class="fullOverlay" style="display:none;">
  <div class="puzzleBox">
    <h2>Ordne die Buchstaben</h2>
    <p>Ziehe die Buchstaben in die richtige Reihenfolge.</p>

    <div class="puzzleSlots" id="puzzleSlots"></div>
    <div class="puzzleLetters" id="puzzleLetters"></div>
  </div>
</div>

<!-- FINALE -->
<div id="finalOverlay" class="fullOverlay" style="display:none;">
  <div class="introBox">
    <div class="introInner">
      <h2>Du hast es geschafft! üéâ</h2>
      <p>Gehe nun zur Rezeption und sage das L√∂sungswort:<br><br>
         <b>WINTERWUNDER</b></p>
    </div>
    <div class="popupFooter">
      <button onclick="location.reload()">Nochmal spielen</button>
    </div>
  </div>
</div>
<script>
/* ============================================================
   INTRO ‚Äî Vorlesen + Weiter-Button-Freigabe
============================================================ */
const introAudio = document.getElementById("introAudio");
const readIntro  = document.getElementById("readIntro");
const startBtn   = document.getElementById("startBtn");

let introIsPlaying = false;

readIntro.addEventListener("click", async ()=>{
  startBtn.style.display="none";

  if(!introIsPlaying){
    introAudio.currentTime = 0;
    await introAudio.play();
    introIsPlaying = true;
    readIntro.textContent = "‚è∏Ô∏è Pause";
  } else {
    introAudio.pause();
    introIsPlaying = false;
    readIntro.textContent = "‚ñ∂Ô∏è Vorlesen";
  }
});

introAudio.addEventListener("ended", ()=>{
  introIsPlaying=false;
  readIntro.textContent="‚ñ∂Ô∏è Vorlesen";
  startBtn.style.display="inline-block";
  startBtn.disabled=false;
});

startBtn.addEventListener("click", ()=>{
  document.getElementById("introOverlay").style.display="none";
  document.getElementById("mainCard").style.display="block";
  loadStation(1);
});

/* ============================================================
   R√ÑTSEL ‚Äî 12 Stationen
============================================================ */
const riddles=[
  null,
  {q:"Ich z√§hle Wochen bis zur Nacht‚Ä¶ Wer darf auf dem Tisch stehen?", a:["adventskranz","der adventskranz"]},
  {q:"Ein Zweig, der K√ºsse bringt. Wie hei√ü ich?", a:["mistel","mistelzweig"]},
  {q:"Ich zieh den Schlitten durch die Nacht. Wer bin ich?", a:["rentier","rentiere"]},
  {q:"Ich fliege nicht, hab aber Kufen.", a:["schlitten","rodel"]},
  {q:"Sechs Sterne, s√º√ü und zimtig fein ‚Äì welches Pl√§tzchen ist gemeint?", a:["zimtstern"]},
  {q:"Ich duft‚Äô nach Honig und Nelken ‚Äì wie hei√ü ich?", a:["lebkuchen","lebkuchenherz"]},
  {q:"Ich bl√ºh im Winter rot im Haus.", a:["weihnachtsstern"]},
  {q:"Ein Stall, ein Kind ‚Äì wie nennt man dieses Bild?", a:["krippe","weihnachtskrippe"]},
  {q:"Ich gl√§nze am Weihnachtsbaum‚Ä¶", a:["christbaumkugel","kugel"]},
  {q:"Ich komme am 6. Dezember.", a:["nikolaus","sankt nikolaus"]},
  {q:"Ich wies den K√∂nigen den Weg.", a:["stern von bethlehem","bethlehemstern"]},
  {q:"Die Nacht vor dem gro√üen Fest.", a:["heiligabend","heiliger abend"]}
];

/* ORTE + BUCHSTABEN */
const stations=[
  null,
  {place:"B√ºcherecke", letter:"W"},
  {place:"Skikeller", letter:"U"},
  {place:"Honesty Shop", letter:"N"},
  {place:"M√ºllraum", letter:"D"},
  {place:"Sauna", letter:"R"},
  {place:"Oberstes Stockwerk", letter:"E"},
  {place:"Wohnungst√ºr 11", letter:"R"},
  {place:"Au√üeneingang Skikeller", letter:"I"},
  {place:"Weihnachtsbaum", letter:"T"},
  {place:"Wohnungst√ºr 35", letter:"N"},
  {place:"Heizraum T√ºr", letter:"W"},
  {place:"Rezeption", letter:"E"}
];


/* ============================================================
   STATION LADEN
============================================================ */
let currentStation=1;
let collectedLetters=[];

function loadStation(n){
  currentStation=n;

  if(n>12){
    startPuzzle();
    return;
  }

  document.getElementById("badge").textContent=`Station ${n} / 12`;
  document.getElementById("riddleText").textContent=riddles[n].q;

  document.getElementById("answerInput").value="";
  document.getElementById("letterInput").value="";
  document.getElementById("errBox").style.display="none";
  document.getElementById("okBox").style.display="none";
  document.getElementById("locBox").style.display="none";
  document.getElementById("letterStep").style.display="none";
}

/* ============================================================
   ANTWORT PR√úFEN
============================================================ */
document.getElementById("checkAnswerBtn").addEventListener("click",()=>{

  let val=normalize(document.getElementById("answerInput").value);
  let correct=riddles[currentStation].a;

  if(!correct.some(a=>normalize(a)===val)){
    document.getElementById("errBox").style.display="block";
    return;
  }

  document.getElementById("errBox").style.display="none";
  document.getElementById("okBox").style.display="block";

  const st=stations[currentStation];

  document.getElementById("locBox").style.display="block";
  document.getElementById("locBox").innerHTML=
    `üìç <b>Ort:</b> ${st.place}<br>Suche dort den Buchstaben!`;

  document.getElementById("letterStep").style.display="block";
});

/* ============================================================
   BUCHSTABEN PR√úFEN
============================================================ */
document.getElementById("letterInput").addEventListener("input",()=>{

  const val=document.getElementById("letterInput").value.trim().toUpperCase();
  const needed=stations[currentStation].letter;

  if(val===needed){
    collectedLetters.push(val);
    document.getElementById("letterPopup").style.display="flex";
  }
});

document.getElementById("popupNextBtn").addEventListener("click",()=>{
  document.getElementById("letterPopup").style.display="none";
  loadStation(currentStation+1);
});

/* NORMALISIERUNG */
function normalize(s){
  return s.toLowerCase().trim()
    .replace(/√§/g,"ae")
    .replace(/√∂/g,"oe")
    .replace(/√º/g,"ue")
    .replace(/√ü/g,"ss");
}

/* ============================================================
   PUZZLE
============================================================ */
let draggedTile=null;

function startPuzzle(){
  document.getElementById("mainCard").style.display="none";
  document.getElementById("puzzleOverlay").style.display="flex";

  const slots=document.getElementById("puzzleSlots");
  const pool=document.getElementById("puzzleLetters");

  slots.innerHTML="";
  pool.innerHTML="";

  for(let i=0;i<12;i++){
    const box=document.createElement("div");
    box.className="slot";
    box.dataset.index=i;
    box.addEventListener("dragover", allowDrop);
    box.addEventListener("drop", dropIntoSlot);
    slots.appendChild(box);
  }

  const mix=[...collectedLetters].sort(()=>Math.random()-0.5);

  mix.forEach(L=>createTile(L,pool));

  pool.addEventListener("dragover", allowDrop);
  pool.addEventListener("drop", dropIntoPool);
}

function createTile(letter,parent){
  const t=document.createElement("div");
  t.className="letterTile";
  t.textContent=letter;
  t.dataset.letter=letter;
  t.draggable=true;

  t.addEventListener("dragstart",dragStart);
  t.addEventListener("dragend",dragEnd);

  t.addEventListener("touchstart",touchStart,{passive:false});
  t.addEventListener("touchmove",touchMove,{passive:false});
  t.addEventListener("touchend",touchEnd,{passive:false});

  parent.appendChild(t);
}

function dragStart(){draggedTile=this; this.style.opacity="0.3";}
function dragEnd(){this.style.opacity="1"; draggedTile=null;}
function allowDrop(e){e.preventDefault();}

function dropIntoSlot(e){
  e.preventDefault();
  if(!draggedTile)return;

  const letter=draggedTile.dataset.letter;

  if(this.textContent.trim()!==""){
    const old=this.textContent.trim();
    createTile(old,document.getElementById("puzzleLetters"));
  }

  this.textContent=letter;
  draggedTile.remove();
  checkSolved();
}

function dropIntoPool(e){
  e.preventDefault();
  if(!draggedTile)return;

  const pool=document.getElementById("puzzleLetters");
  const letter=draggedTile.dataset.letter;

  document.querySelectorAll(".slot").forEach(s=>{
    if(s.textContent.trim()===letter) s.textContent="";
  });

  createTile(letter,pool);
  draggedTile.remove();

  checkSolved();
}

/* TOUCH */
let touchTile=null;

function touchStart(e){
  e.preventDefault();
  touchTile=this;
  this.style.opacity="0.4";
}

function touchMove(e){
  e.preventDefault();
  if(!touchTile)return;
}

function touchEnd(e){
  if(!touchTile)return;

  touchTile.style.opacity="1";

  const t=e.changedTouches[0];
  const target=document.elementFromPoint(t.clientX,t.clientY);

  draggedTile=touchTile;

  if(target && target.classList.contains("slot")){
    dropIntoSlot.call(target,e);
  } else {
    dropIntoPool.call(document.getElementById("puzzleLetters"),e);
  }

  touchTile=null;
}

/* L√ñSUNG PR√úFEN */
function checkSolved(){
  const word=[...document.querySelectorAll(".slot")]
              .map(s=>s.textContent.trim())
              .join("");

  if(word.length!==12)return;

  if(word==="WINTERWUNDER"){
    setTimeout(()=>{
      document.getElementById("puzzleOverlay").style.display="none";
      document.getElementById("finalOverlay").style.display="flex";
    },300);
  } else {
    setTimeout(resetPuzzle,500);
  }
}

function resetPuzzle(){
  const pool=document.getElementById("puzzleLetters");
  pool.innerHTML="";

  document.querySelectorAll(".slot").forEach(slot=>{
    const letter=slot.textContent.trim();
    if(letter!==""){
      createTile(letter,pool);
      slot.textContent="";
    }
  });
}
</script>

</body>
</html>

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Der letzte Weihnachtszauber ‚Äì Hapimag Saalbach</title>

<style>
:root{
  --rot: #b9121b;
  --rot-hell:#d82933;
  --rot-dunkel:#7a0c11;
  --gold:#f6d772;
  --text:#2a2a2a;
  --karte:rgba(255,255,255,0.96);
  --radius:22px;
  --shadow:0 10px 40px rgba(0,0,0,0.25);
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}

/* Hintergrund */
body{
  font-family: system-ui, Arial, sans-serif;
  color:var(--text);

  /* Weihnachtslandschaft */
  background-image:url("Winterlandschaft.jpg");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;

  min-height:100vh;
  padding:18px;
}

/* Hapimag Logo */
#hapimagLogo{
  position:fixed;
  top:14px;
  right:14px;
  width:140px;
  opacity:0.95;
  z-index:9999;
}

/* Haupt-Wrapper */
.wrap{
  width:min(980px,100%);
  margin:auto;
}

/* Karte */
.card{
  background:var(--karte);
  border-radius:var(--radius);
  padding:24px;
  box-shadow:var(--shadow);
}

/* Header */
.head{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px;
  align-items:center;
}

.icon-small{
  width:70px;
}

.title{
  font-size:clamp(1.6rem,2vw,2rem);
  color:var(--rot-dunkel);
  margin:0;
}

.badge{
  display:inline-block;
  background:#fff5f5;
  padding:4px 12px;
  border-radius:14px;
  border:1px solid #ffdbdb;
  color:var(--rot);
  font-size:0.85rem;
  margin-top:4px;
}

/* Buttons */
button{
  cursor:pointer;
  padding:0.9rem 1.4rem;
  border-radius:16px;
  border:2px solid var(--rot);
  background:var(--rot);
  color:white;
  font-weight:700;
  transition:0.2s;
  font-size:1rem;
}
button:hover{filter:brightness(1.1)}
button.secondary{
  background:white;
  color:var(--rot);
}

/* Inputs */
label{
  font-weight:600;
  margin-top:1rem;
  display:block;
}
input{
  width:100%;
  padding:0.9rem 1rem;
  border:2px solid #ffd4d4;
  font-size:1rem;
  border-radius:14px;
  margin-top:0.3rem;
}

/* Feedback */
.err{
  display:none;
  color:#c62828;
  font-weight:700;
  margin-top:0.7rem;
}
.ok{
  display:none;
  background:#e8ffe8;
  border:2px solid #62c06c;
  padding:0.9rem 1rem;
  margin-top:0.9rem;
  border-radius:14px;
  color:#115b17;
  font-weight:700;
}

/* Ortsbox */
.loc{
  display:none;
  background:#fff7f0;
  border:2px solid #ffe0bf;
  padding:1rem;
  border-radius:14px;
  margin-top:1rem;
  font-weight:700;
}

/* Overlay */
.fullOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2000;
  padding:20px;
}

/* Intro */
.introBox{
  width:min(900px,92%);
  max-height:92vh;
  background:white;
  border-radius:var(--radius);
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow);
}
.introInner{
  padding:22px;
  text-align:center;
}
.intro-zirbel{
  max-width:260px;
  display:block;
  margin:auto;
}

/* Popup */
.popupBox{
  width:min(900px,92%);
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.popupInner{
  padding:24px;
  text-align:center;
}

/* Puzzle */
.puzzleBox{
  width:min(900px,92%);
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:26px;
  text-align:center;
}
.puzzleSlots, .puzzleLetters{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:18px;
}
.slot{
  width:65px;
  height:65px;
  border:2px dashed #ffded9;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.7rem;
  color:var(--rot-dunkel);
  font-weight:800;
  background:#fff8f8;
}
.letterTile{
  width:65px;
  height:65px;
  background:var(--rot);
  color:white;
  font-weight:800;
  font-size:1.7rem;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
  user-select:none;
}
.letterTile:active{
  cursor:grabbing;
  transform:scale(1.07);
}
</style>
</head>

<body>

<!-- Hapimag Logo -->
<img src="hapimag_logo.png" id="hapimagLogo">

<!-- INTRO -->
<div id="introOverlay" class="fullOverlay">
  <div class="introBox">
    <div class="introInner">
      <h2 class="introTitle">Der letzte Weihnachtszauber</h2>

      <!-- Weihnachtsmann-Bild -->
      <img src="Weihnachtsmann.jpg" class="intro-santa">

      <p class="introText">
        In der l√§ngsten Nacht des Winters liegt das alte Haus still im Schnee ‚Äì und doch scheint es zu atmen.
        Drinnen flackert ein schwaches Licht, als w√ºrde jemand warten. Vor langer Zeit verga√ü das Christkind hier ein letztes Geschenk.
        Eine Truhe, versiegelt mit einem Zahlencode, den selbst der Himmel nicht mehr kennt. Seit jener Nacht ruht der Weihnachtszauber in ihr ‚Äì unerweckt, unerl√∂st.
        <br><br>
        Doch das Haus ist nicht stumm. Es fl√ºstert R√§tsel durch seine Flure, l√§sst Schatten tanzen und Kerzen flackern, als wollten sie f√ºhren.
        Wer genau hinh√∂rt, sp√ºrt, dass die Antworten √ºberall verborgen sind ‚Äì im Knirschen des Schnees, im Wispern des Windes, in Zeichen, die nur im rechten Moment sichtbar werden.
        <br><br>
        Drei Ziffern √∂ffnen die Truhe. Zw√∂lf schwere R√§tsel f√ºhren dorthin.
        Folge dem Ruf der Nacht, lausche den Hinweisen ‚Äì und vielleicht wirst du das Geschenk finden, das das Christkind selbst vergessen hat.
      </p>

      <!-- Vorlesen Button -->
      <button id="readIntro" class="secondary">‚ñ∂Ô∏è Vorlesen</button>

      <!-- AUDIO -->
      <audio id="introAudio" preload="auto" src="ElevenLabs_Text_to_Speech_audio.mp3"></audio>

    </div>

    <div class="popupFooter">
      <!-- Weiter erst NACH Audio -->
      <button id="startBtn" disabled style="display:none;">Weiter zur R√§tseltour ‚ú®</button>
    </div>
  </div>
</div>


    <div style="padding:16px; text-align:center; border-top:1px solid #ffe2e2; background:#fff9f9;">
      <button id="startBtn" disabled>Weiter zur R√§tseltour ‚ú®</button>
    </div>
  </div>
</div>
<!-- POPUP nach gefundenem Buchstaben -->
<div id="letterPopup" class="fullOverlay" style="display:none;">
  <div class="popupBox">
    <div class="popupInner">

      <img src="weihnachtsmann_popup.png" class="intro-zirbel">

      <h2 style="color:var(--rot-dunkel); margin-top:10px;">Super gemacht! üéÖ‚ú®</h2>

      <p id="popupText" style="margin-top:8px; line-height:1.5;">
        Du hast eine geheime Weihnachts-Spur entdeckt! Weiter so ‚Äì der letzte Weihnachtszauber wartet!
      </p>
    </div>

    <div style="padding:16px; background:#fff5f5; border-top:1px solid #ffd7d7; text-align:center;">
      <button id="popupNextBtn">Weiter ‚ûú</button>
    </div>
  </div>
</div>


<!-- HAUPT-R√ÑTSEL -->
<main class="wrap">
  <section class="card" id="mainCard" style="display:none;">

    <header class="head">
      <img src="weihnachts_baum.png" class="icon-small">

      <div>
        <h1 class="title">Der letzte Weihnachtszauber</h1>
        <p style="margin:4px 0; color:var(--rot);">Finde alle 12 Buchstaben ‚Äì am Ende entsteht das L√∂sungswort!</p>

        <span class="badge" id="badge"></span>
      </div>

      <img src="weihnachts_baum.png" class="icon-small">
    </header>


    <h2 id="riddleTitle" style="margin-top:20px; color:var(--rot-dunkel);">R√§tsel</h2>
    <p id="riddleText" style="line-height:1.6; margin-top:6px;"></p>

    <label style="margin-top:20px;">Deine Antwort</label>
    <input id="answerInput" autocomplete="off" placeholder="Antwort eingeben‚Ä¶">

    <button id="checkAnswerBtn" style="margin-top:1rem;">Antwort pr√ºfen</button>

    <div class="err" id="errBox">Leider falsch ‚Äì versuch's nochmal!</div>
    <div class="ok" id="okBox">Richtig!</div>

    <div id="locBox" class="loc"></div>

    <div id="letterStep" style="display:none;">
      <label style="margin-top:1rem;">Buchstabe vom Ort</label>
      <input id="letterInput" maxlength="1" placeholder="Buchstabe eingeben‚Ä¶">
    </div>

  </section>
</main>


<!-- PUZZLE OVERLAY (12 Buchstaben f√ºr WINTERWUNDER) -->
<div id="puzzleOverlay" class="fullOverlay" style="display:none;">
  <div class="puzzleBox">

    <h2 style="color:var(--rot-dunkel);">Sortiere die Weihnachts-Buchstaben</h2>
    <p style="margin-top:8px;">Ziehe alle Buchstaben in die richtige Reihenfolge.</p>

    <div class="puzzleSlots" id="puzzleSlots"></div>
    <div class="puzzleLetters" id="puzzleLetters"></div>

  </div>
</div>


<!-- FINALE -->
<div id="finalOverlay" class="fullOverlay" style="display:none;">
  <div class="introBox">
    <div class="introInner" style="text-align:center;">

      <img src="weihnachtsmann_popup.png" class="intro-zirbel">

      <h2 class="introTitle" style="color:var(--rot-dunkel); margin-top:18px;">
        Du hast den letzten Weihnachtszauber gefunden! ‚ú®
      </h2>

      <p style="margin-top:12px; line-height:1.6;">
        Du hast alle 12 Buchstaben richtig sortiert!<br><br>
        Gehe nun zur Rezeption und sage das L√∂sungswort:<br>
        <b>WINTERWUNDER</b><br><br>
        Dort erh√§ltst du die Hinweise auf den dreistelligen Geheimcode der Truhe.
      </p>
    </div>

    <div style="padding:16px; background:#fff5f5; border-top:1px solid #ffd7d7; text-align:center;">
      <button onclick="location.reload()">Nochmal spielen</button>
    </div>
  </div>
</div>
<script>
/* ============================================================
   INTRO AUDIO
============================================================ */
const introAudio = document.getElementById("introAudio");
const readIntro = document.getElementById("readIntro");
const startBtn = document.getElementById("startBtn");

let introIsPlaying = false;

readIntro.addEventListener("click", async ()=>{
  if(!introIsPlaying){
    introAudio.currentTime = 0;
    await introAudio.play();
    introIsPlaying = true;
    readIntro.textContent = "‚è∏Ô∏è Pause";
  } else {
    introAudio.pause();
    introIsPlaying = false;
    readIntro.textContent = "‚ñ∂Ô∏è Vorlesen";
  }
});

introAudio.addEventListener("ended", ()=>{
  introIsPlaying = false;
  readIntro.textContent = "‚ñ∂Ô∏è Vorlesen";
  startBtn.disabled = false;
});

startBtn.addEventListener("click", ()=>{
  document.getElementById("introOverlay").style.display = "none";
  document.getElementById("mainCard").style.display = "block";
  loadStation(1);
});


/* ============================================================
   R√ÑTSEL ‚Äì 12 STATIONEN ‚Äì WEIHNACHTSTHEMA
============================================================ */
const riddles = [
  null,

  {q:"Ich z√§hle Wochen bis zur Nacht, die Hoffnung, Stille, Freude macht. Mit Kerzenschein ‚Äì wer darf auf eurem Tisch stehen?", a:["adventskranz","der adventskranz","advents-kranz"]},

  {q:"Ein Zweig, der kleinen Zauber bringt: Wer drunter steht, bekommt oft K√ºsse. Wie hei√ü‚Äô ich?", a:["mistel","mistelzweig","der mistelzweig"]},

  {q:"Ich zieh den Schlitten durch die Nacht ‚Äì mal rot die Nase, mal im Rudel. Wer bin ich?", a:["rentier","rentiere"]},

  {q:"Ich fliege nicht, hab aber Kufen, zieh Spuren durch den Schnee. Wie hei√ü ich?", a:["schlitten","rodel"]},

  {q:"Sechs Sterne, s√º√ü und zimtig fein ‚Äì welches Pl√§tzchen mag das sein?", a:["zimtstern","der zimtstern"]},

  {q:"Ich duft‚Äô nach Honig, Nelken, W√§rme ‚Äì ein Herz, ein Haus, ein Stern aus Teig. Wie hei√ü ich?", a:["lebkuchen","lebkuchenherz","lebkuchen-herz"]},

  {q:"Ich bl√ºh im Winter rot im Haus ‚Äì wie hei√ü ich?", a:["weihnachtsstern"]},

  {q:"Ein Stall, ein Kind, zwei Leute ‚Äì wie hei√üt das Bild vom Weihnachtskind?", a:["krippe","weihnachtskrippe"]},

  {q:"Ich bin aus Glas und kugelrund ‚Äì funkel hell am gr√ºnen Baum. Wie hei√ü ich?", a:["christbaumkugel","baumkugel","kugel","weihnachtskugel"]},

  {q:"Ich komme fr√ºh im Dezember an ‚Äì im Stiefel hinterlass ich Gaben. Wer bin ich?", a:["nikolaus","sankt nikolaus","st nikolaus"]},

  {q:"Ich wies den K√∂nigen den Weg ‚Äì wie hei√üt der ber√ºhmte Stern?", a:["stern von bethlehem","bethlehemstern"]},

  {q:"Ich bin die Nacht, bevor es schimmert ‚Äì wie hei√ü ich?", a:["heiligabend","heiliger abend","christabend"]}
];


/* ============================================================
   ORTE & BUCHSTABEN (L√ñSUNGSWORT = WINTERWUNDER ‚Üí 12 Buchstaben)
============================================================ */
const stations = [
  null,
  {place:"B√ºcherecke", letter:"W"},
  {place:"Skikeller", letter:"U"},
  {place:"Honesty Shop", letter:"N"},
  {place:"M√ºllraum", letter:"D"},
  {place:"Sauna", letter:"R"},
  {place:"Oberstes Stockwerk", letter:"E"},
  {place:"Wohnungst√ºr 11", letter:"R"},
  {place:"Au√üeneingang Skikeller", letter:"I"},
  {place:"Weihnachtsbaum", letter:"T"},
  {place:"Wohnungst√ºr 35", letter:"N"},
  {place:"Eingangst√ºr Heizkeller", letter:"W"},
  {place:"Rezeption", letter:"E"}
];

/* ============================================================
   STATE
============================================================ */
let currentStation = 1;
let collectedLetters = [];


/* ============================================================
   STATION LADEN
============================================================ */
function loadStation(n){
  currentStation = n;

  if(n > 12){
    startPuzzle();
    return;
  }

  const r = riddles[n];

  document.getElementById("badge").textContent = `Station ${n} / 12`;
  document.getElementById("riddleText").textContent = r.q;

  document.getElementById("answerInput").value = "";
  document.getElementById("letterInput").value = "";

  document.getElementById("errBox").style.display = "none";
  document.getElementById("okBox").style.display = "none";
  document.getElementById("locBox").style.display = "none";
  document.getElementById("letterStep").style.display = "none";
}


/* ============================================================
   ANTWORT PR√úFEN
============================================================ */
document.getElementById("checkAnswerBtn").addEventListener("click", ()=>{

  const val = normalize(document.getElementById("answerInput").value);
  const correct = riddles[currentStation].a;

  const ok = correct.some(c => normalize(c) === val);

  if(!ok){
    document.getElementById("errBox").style.display="block";
    return;
  }

  document.getElementById("errBox").style.display="none";
  document.getElementById("okBox").style.display="block";

  const st = stations[currentStation];
  document.getElementById("locBox").style.display="block";
  document.getElementById("locBox").innerHTML =
    `üìç <b>Ort:</b> ${st.place}<br>Suche dort den Buchstaben!`;

  document.getElementById("letterStep").style.display="block";
});


/* ============================================================
   BUCHSTABE PR√úFEN
============================================================ */
document.getElementById("letterInput").addEventListener("input", ()=>{

  const val = document.getElementById("letterInput").value.trim().toUpperCase();
  const needed = stations[currentStation].letter;

  if(val === needed){

    collectedLetters.push(val);

    document.getElementById("letterPopup").style.display="flex";
  }
});

document.getElementById("popupNextBtn").addEventListener("click", ()=>{
  document.getElementById("letterPopup").style.display = "none";
  loadStation(currentStation + 1);
});


/* ============================================================
   NORMALISIERUNG
============================================================ */
function normalize(s){
  return s.toLowerCase().trim()
    .replace(/√§/g,"ae")
    .replace(/√∂/g,"oe")
    .replace(/√º/g,"ue")
    .replace(/√ü/g,"ss");
}


/* ============================================================
   PUZZLE ‚Äì DRAG & DROP (12 Buchstaben)
============================================================ */

let draggedTile = null;

/* PUZZLE START */
function startPuzzle(){

  document.getElementById("mainCard").style.display="none";
  document.getElementById("puzzleOverlay").style.display="flex";

  const slots = document.getElementById("puzzleSlots");
  slots.innerHTML = "";

  for(let i=0;i<12;i++){
    const box = document.createElement("div");
    box.className = "slot";
    box.dataset.index = i;
    box.addEventListener("dragover", allowDrop);
    box.addEventListener("drop", dropIntoSlot);
    slots.appendChild(box);
  }

  const pool = document.getElementById("puzzleLetters");
  pool.innerHTML = "";

  const letters = [...collectedLetters];
  letters.sort(()=> Math.random() - 0.5);

  letters.forEach(L=> createTile(L, pool));

  pool.addEventListener("dragover", allowDrop);
  pool.addEventListener("drop", dropIntoPool);
}


/* TILE ERSTELLEN */
function createTile(letter, parent){
  const t = document.createElement("div");
  t.className = "letterTile";
  t.textContent = letter;
  t.dataset.letter = letter;
  t.draggable = true;

  t.addEventListener("dragstart", dragStart);
  t.addEventListener("dragend", dragEnd);

  // Touch
  t.addEventListener("touchstart", touchStart, {passive:false});
  t.addEventListener("touchmove", touchMove, {passive:false});
  t.addEventListener("touchend", touchEnd, {passive:false});

  parent.appendChild(t);
}


/* DRAG START */
function dragStart(){
  draggedTile = this;
  this.style.opacity="0.3";
}

/* DRAG END */
function dragEnd(){
  this.style.opacity="1";
  draggedTile=null;
}

function allowDrop(e){
  e.preventDefault();
}


/* DROP INTO SLOT */
function dropIntoSlot(e){
  e.preventDefault();
  if(!draggedTile) return;

  const letter = draggedTile.dataset.letter;

  if(this.textContent.trim() !== ""){
    const old = this.textContent.trim();
    createTile(old, document.getElementById("puzzleLetters"));
  }

  this.textContent = letter;
  draggedTile.remove();

  checkSolved();
}


/* DROP BACK INTO POOL */
function dropIntoPool(e){
  e.preventDefault();
  if(!draggedTile) return;

  const pool = document.getElementById("puzzleLetters");
  const letter = draggedTile.dataset.letter;

  document.querySelectorAll(".slot").forEach(slot=>{
    if(slot.textContent.trim() === letter){
      slot.textContent="";
    }
  });

  createTile(letter, pool);
  draggedTile.remove();

  checkSolved();
}


/* TOUCH HANDLING */
let touchTile = null;

function touchStart(e){
  e.preventDefault();
  touchTile = this;
  this.style.opacity="0.4";
}

function touchMove(e){
  e.preventDefault();
  if(!touchTile) return;

  const t = e.touches[0];
  const elem = document.elementFromPoint(t.clientX, t.clientY);

  document.querySelectorAll(".slot").forEach(s=> s.style.outline="");

  if(elem && elem.classList.contains("slot")){
    elem.style.outline="3px solid var(--rot)";
  }
}

function touchEnd(e){

  if(!touchTile) return;

  touchTile.style.opacity="1";
  const t = e.changedTouches[0];
  const target = document.elementFromPoint(t.clientX, t.clientY);

  document.querySelectorAll(".slot").forEach(s=> s.style.outline="");

  draggedTile = touchTile;

  if(target && target.classList.contains("slot")){
    dropIntoSlot.call(target, e);
  } else {
    dropIntoPool.call(document.getElementById("puzzleLetters"), e);
  }

  touchTile = null;
}


/* ============================================================
   L√ñSUNG CHECKEN
============================================================ */
function checkSolved(){

  const word = [...document.querySelectorAll(".slot")]
          .map(s=>s.textContent.trim())
          .join("");

  if(word.length !== 12) return;

  if(word === "WINTERWUNDER"){
    setTimeout(()=>{
      document.getElementById("puzzleOverlay").style.display="none";
      document.getElementById("finalOverlay").style.display="flex";
    },300);

  } else {
    // Reset alles
    setTimeout(resetPuzzle,500);
  }
}


/* ============================================================
   RESET
============================================================ */
function resetPuzzle(){
  const pool = document.getElementById("puzzleLetters");
  pool.innerHTML="";

  document.querySelectorAll(".slot").forEach(slot=>{
    const letter = slot.textContent.trim();
    if(letter !== ""){
      createTile(letter, pool);
      slot.textContent="";
    }
  });
}

</script>
</body>
</html>

